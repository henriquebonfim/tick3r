name: CI/CD

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build-and-deploy:
    permissions:
      contents: read
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install Dependencies
        run: bun install

      - name: Build
        run: bun run build
        env:
          VITE_FIREBASE_MEASUREMENT_ID: ${{ secrets.VITE_FIREBASE_MEASUREMENT_ID }}

      - name: Deploy to Preview Channel
        if: github.event_name == 'pull_request'
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        run: |
          # Create a channel ID based on the PR number
          CHANNEL_ID="pr-${{ github.event.number }}"
          # Deploy and capture JSON output
          OUTPUT=$(npx firebase-tools hosting:channel:deploy "$CHANNEL_ID" --expires 1h --project tick3r --json)
          echo "$OUTPUT"

          # Extract URL
          URL=$(echo "$OUTPUT" | jq -r '.result.tick3r.url')

          # Print URL to annotation and log
          echo "::notice title=Preview URL::$URL"
          echo "Final Deployment URL: $URL"

      - name: Deploy to Production
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        run: |
          OUTPUT=$(npx firebase-tools deploy --only hosting --project tick3r --json)
          echo "$OUTPUT"

          # Print URL to annotation and log
          # Extract URL from JSON output
          URL=$(echo "$OUTPUT" | jq -r '.result.hosting | .. | .url? | select(. != null) | select(startswith("https"))' | head -n 1)

          # Fallback
          if [ -z "$URL" ] || [ "$URL" = "null" ]; then
            URL="https://tick3r.web.app"
          fi

          echo "::notice title=Production URL::$URL"
          echo "Final Deployment URL: $URL"
